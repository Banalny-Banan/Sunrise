using Exiled.Events.EventArgs.Scp3114;
using PlayerRoles.PlayableScps.Scp3114;
using PlayerRoles.Subroutines;

namespace Sunrise.Features.ExploitPatches;

/// <summary>
///     Enforces cooldowns for SCP-3114 abilities on server-side.
/// </summary>
internal class Scp3114CooldownsExploitPatchModule : PluginModule
{
    protected override void OnEnabled()
    {
        Handlers.Scp3114.Disguising += OnDisguising;
        Handlers.Scp3114.Strangling += OnStrangling;
    }

    protected override void OnDisabled()
    {
        Handlers.Scp3114.Disguising -= OnDisguising;
        Handlers.Scp3114.Strangling -= OnStrangling;
    }

    void OnDisguising(DisguisingEventArgs ev)
    {
        AbilityCooldown cooldown = ev.Scp3114.Disguise.Cooldown;

        if (!cooldown.IsReady)
            ev.IsAllowed = false;
    }

    void OnStrangling(StranglingEventArgs ev)
    {
        Scp3114Strangle strangle = ev.Scp3114.Slap._strangle;
        float remainingTimeToUse = strangle._strangleTimer; // The 12-second window of time after removing disguise when the strangle ability is available
        float useCooldown = strangle.ClientCooldown.Remaining; // The short cooldown after strangle is interrupted or canceled

        bool canUse = remainingTimeToUse + Config.Instance.AccountedLatencySeconds > 0f && useCooldown <= Config.Instance.AccountedLatencySeconds;

        if (!canUse)
            ev.IsAllowed = false;
    }
}